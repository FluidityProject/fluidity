#    Copyright (C) 2007 Imperial College London and others.
#
#    Please see the AUTHORS file in the main source directory for a full list
#    of copyright holders.
#
#    Applied Modelling and Computation Group
#    Department of Earth Science and Engineering
#    Imperial College London
#
#    David.Ham@Imperial.ac.uk
#
#    This library is free software; you can redistribute it and/or
#    modify it under the terms of the GNU Lesser General Public
#    License as published by the Free Software Foundation,
#    version 2.1 of the License.
#
#    This library is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
#    Lesser General Public License for more details.
#
#    You should have received a copy of the GNU Lesser General Public
#    License along with this library; if not, write to the Free Software
#    Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307
#    USA

SHELL = /bin/sh

FC      = @FC@
FCFLAGS = -I@srcdir@/include @CPPFLAGS@ @FCFLAGS@

CXX     = @CXX@
CXXFLAGS= -I@srcdir@/include @CPPFLAGS@ @CXXFLAGS@

MAKE    = @MAKE@
AR      = @AR@
ARFLAGS = @ARFLAGS@

LIB = libspud.la
LIBS = $(shell echo @LIBS@ | sed 's/-L /-L/g')

HEADERS = @srcdir@/include/spud.h @srcdir@/include/spud @srcdir@/include/spud_enums.h @srcdir@/include/tinystr.h @srcdir@/include/tinyxml.h
MODS = spud.mod
OBJS = spud.lo spud_interfaces.lo tinystr.lo tinyxml.lo tinyxmlerror.lo tinyxmlparser.lo fspud.lo

VPATH = @srcdir@/src/

.SUFFIXES: .f90 .F90 .c .cpp .lo .la

.f90.lo:
	./libtool --mode=compile --tag=FC $(FC) $(FCFLAGS) -c $<
.cpp.lo:
	./libtool --mode=compile --tag=CXX $(CXX) $(CXXFLAGS) -c $<

default: libspud.la build-diamond

libspud.la: $(OBJS)
	./libtool --mode=link --tag=FC $(FC) $(FCFLAGS) -o $(LIB) $(OBJS) $(LIBS) -rpath @prefix@/lib 
	if test -f .libs/libspud.a; then cp .libs/libspud.a .; fi
	(if test -f .libs/libspud.so; then cp .libs/libspud.so ./libspud.so.0; ln -s libspud.so.0 libspud.so; fi) || true

build-diamond:
	cd @srcdir@/diamond; python $(CURDIR)/diamond/setup.py build -t $(CURDIR)/diamond/ -b $(CURDIR)/diamond/

test: unittest

unittest: libspud.la
	@cd src/tests; $(MAKE)

.PHONY:doc

doc: 
	@cd doc; $(MAKE) spud_manual.pdf

install: install-libspud install-spudtools install-diamond install-pyspud install-dxdiff

install-libspud: libspud.la
	@INSTALL@ -d $(DESTDIR)@prefix@/lib
	@INSTALL@ -d $(DESTDIR)@prefix@/include
	@INSTALL@ libspud.a $(DESTDIR)@prefix@/lib
	(if test -f libspud.so.0; then @INSTALL@ libspud.so.0 $(DESTDIR)@prefix@/lib; fi) || true
	(if test -f libspud.so; then cd $(DESTDIR)@prefix@/lib/; ln -s libspud.so.0 libspud.so; cd -; fi) || true
	@INSTALL@ $(MODS) $(DESTDIR)@prefix@/include
	@INSTALL@ $(HEADERS) $(DESTDIR)@prefix@/include

install-spudtools: 
	@INSTALL@ -d $(DESTDIR)@prefix@/share/spud
	@INSTALL@ -d $(DESTDIR)@prefix@/bin
	@INSTALL@ -m755 bin/spud-preprocess $(DESTDIR)@prefix@/bin
	@INSTALL@ -m755 bin/spud-set $(DESTDIR)@prefix@/bin
	@INSTALL@ -m644 schema/spud_base.rnc $(DESTDIR)@prefix@/share/spud
	@INSTALL@ -m644 schema/spud_base.rng $(DESTDIR)@prefix@/share/spud

install-diamond:
	cd @srcdir@/diamond; python $(CURDIR)/diamond/setup.py install --prefix=$(DESTDIR)@prefix@; cd ..

install-pyspud:
ifeq ($(origin BUILDING_DEBIAN),undefined)
	cd @srcdir@/python; python setup.py install --prefix=$(DESTDIR)@prefix@
else
	cd @srcdir@/python; for python in $(shell pyversions -r); do $$python setup.py install --prefix=$(DESTDIR)@prefix@ --install-layout=deb; done
endif

install-dxdiff:
ifeq ($(origin DESTDIR),undefined)
	cd @srcdir@/dxdiff; python setup.py install --prefix=$(DESTDIR)@prefix@
else
	cd @srcdir@/dxdiff; for python in $(shell pyversions -r); do $$python setup.py install --prefix=$(DESTDIR)@prefix@ --install-layout=deb; done
endif

# for out-of-tree builds not all subdirs necessarily exist, so we have to fail graciously:
clean:
	$(MAKE) -C doc clean || true
	rm -f *.o libspud.a libspud.so* *.o *.la *.mod *.lo
	rm -rf .libs
	$(MAKE) -C src/tests clean
	rm -rf diamond/build
	rm -rf python/build
	rm -rf dxdiff/build


distclean: clean
	$(MAKE) -C src/tests distclean
	rm -fr config.log config.status libtool autom4te.cache Makefile
	rm -f Makefile src/tests/Makefile examples/Makefile
	rm -f bin/spud-preprocess
	rm -f diamond/setup.py diamond/diamond/plugins.py diamond/diamond/preprocess.py
